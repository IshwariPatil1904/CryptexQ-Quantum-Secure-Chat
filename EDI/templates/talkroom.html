<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptexQ Secure Chat Room</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-dark: #0d1b2a;
            --secondary-dark: #1b263b;
            --medium: #415a77;
            --light: #778da9;
            --accent: #e0e1dd;
            --highlight: #4cc9f0;
            --error: #e63946;
            --success: #2a9d8f;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Montserrat', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary-dark) 100%);
            color: var(--accent);
            line-height: 1.6;
            min-height: 100vh;
            padding: 0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Navbar */
        .navbar {
            background: #0f1724;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 2rem;
            border-bottom: 2px solid rgba(138, 43, 226, 0.3);
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .navbar .logo {
            display: flex;
            align-items: center;
            font-size: 1.4rem;
            font-weight: bold;
            color: #c084fc;
            text-decoration: none;
        }
        .navbar .logo span {
            background: linear-gradient(90deg,#c084fc,#60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-left: 0.4rem;
        }
        .navbar .menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .navbar .menu a {
            text-decoration: none;
            color: #e5e7eb;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        .navbar .menu a:hover,
        .navbar .menu .active {
            color: #60a5fa;
        }

        .dropdown { position: relative; }
        .dropdown-content {
            display: none;
            position: absolute;
            top: 2.5rem;
            left: 0;
            background: #1a2238;
            border-radius: 0.5rem;
            min-width: 150px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            z-index: 10;
        }
        .dropdown-content a {
            display: block;
            padding: 0.6rem 1rem;
            color: #e5e7eb;
            text-decoration: none;
        }
        .dropdown-content a:hover {
            background: #2c3654;
            color: #60a5fa;
        }
        .dropdown:hover .dropdown-content { display: block; }

        .navbar .actions {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.6rem;
            font-weight: 500;
            text-decoration: none;
            transition: background 0.3s ease;
        }
        .btn-login {
            background: #1e293b;
            color: #fbbf24;
        }
        .btn-login:hover { background: #334155; }
        .btn-signup {
            background: linear-gradient(90deg,#8b5cf6,#3b82f6);
            color: #fff;
        }
        .btn-signup:hover { opacity: 0.9; }
        
        .chat-container {
            background: rgba(27, 38, 59, 0.8);
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(13, 27, 42, 0.7);
            border-bottom: 1px solid var(--medium);
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .connected {
            background-color: var(--success);
            box-shadow: 0 0 10px var(--success);
        }
        
        .disconnected {
            background-color: var(--light);
        }
        
        .warning {
            background-color: var(--error);
            box-shadow: 0 0 10px var(--error);
        }
        
        .key-exchange {
            display: flex;
            justify-content: space-between;
            padding: 20px;
            background: rgba(13, 27, 42, 0.5);
            border-bottom: 1px solid var(--medium);
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .key-box {
            flex: 1;
            min-width: 250px;
        }
        
        .key-box h3 {
            margin-bottom: 10px;
            color: var(--accent);
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .key-value {
            background: rgba(13, 27, 42, 0.7);
            border: 1px solid var(--medium);
            border-radius: 8px;
            padding: 12px;
            font-family: monospace;
            font-size: 0.8rem;
            overflow-x: auto;
            white-space: normal;
            word-break: break-all;
            color: var(--accent);
            min-height: 44px;
            position: relative;
        }
        
        .copy-btn {
            position: absolute;
            right: 8px;
            top: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 4px;
            color: var(--accent);
            padding: 4px 8px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .copy-btn:hover { background: rgba(255, 255, 255, 0.3); }
        
        button {
            background: linear-gradient(90deg, var(--highlight) 0%, #b5179e 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: transform 0.3s, box-shadow 0.3s;
            margin-top: 10px;
            width: 100%;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 201, 240, 0.3);
        }
        
        button:disabled {
            background: var(--medium);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
        }
        
        .chat-area {
            display: flex;
            flex-direction: column;
            height: 500px;
            background: rgba(13, 27, 42, 0.7);
            overflow: hidden;
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 12px 15px;
            border-radius: 8px;
            max-width: 80%;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.sent {
            background: linear-gradient(90deg, var(--highlight) 0%, #4361ee 100%);
            margin-left: auto;
            border-bottom-right-radius: 2px;
        }
        
        .message.received {
            background: rgba(65, 90, 119, 0.5);
            border-bottom-left-radius: 2px;
        }
        
        .message-info {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        .input-area {
            display: flex;
            padding: 15px;
            border-top: 1px solid var(--medium);
            background: rgba(27, 38, 59, 0.5);
        }
        
        input[type="text"] {
            flex: 1;
            padding: 15px;
            background: rgba(13, 27, 42, 0.7);
            border: 1px solid var(--medium);
            border-radius: 8px;
            color: var(--accent);
            font-size: 1rem;
            margin-right: 10px;
        }
        
        input:focus {
            outline: none;
            border-color: var(--highlight);
        }
        
        .tab-container {
            display: flex;
            border-bottom: 1px solid var(--medium);
            background: rgba(27, 38, 59, 0.5);
            margin-top: 20px;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            overflow: hidden;
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            background: rgba(27, 38, 59, 0.3);
            border-right: 1px solid var(--medium);
            font-weight: 500;
            transition: background 0.3s;
        }
        
        .tab.active {
            background: rgba(13, 27, 42, 0.7);
            border-bottom: 2px solid var(--highlight);
        }
        
        .tab-content {
            display: none;
            border-bottom-left-radius: 12px; 
            border-bottom-right-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .explanation {
            background: rgba(13, 27, 42, 0.7);
            padding: 25px;
            border-radius: 0 0 12px 12px;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        .explanation h3 {
            color: var(--highlight);
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: var(--light);
            font-size: 0.9rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: var(--secondary-dark);
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }
        
        .modal h2 {
            margin-bottom: 20px;
            color: var(--highlight);
        }
        
        .modal input {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            background: rgba(13, 27, 42, 0.7);
            border: 1px solid var(--medium);
            border-radius: 8px;
            color: var(--accent);
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .modal-buttons button {
            width: auto;
        }
        
        .modal-buttons button.secondary {
            background: var(--medium);
        }
        
        .mode-settings {
            padding: 20px;
            background: rgba(13, 27, 42, 0.7);
            border-top: 1px solid var(--medium);
            border-radius: 0 0 12px 12px;
        }

        .mode-settings > div {
            padding: 15px;
            border: 1px solid var(--medium);
            border-radius: 8px;
            margin-bottom: 15px;
        }

        @media (max-width: 900px) {
            .key-exchange { flex-direction: column; }
            .message { max-width: 90%; }
            .navbar .menu, .navbar .actions { display: none; }
            .navbar { justify-content: center; }
        }

                    /* ---- Banner Animation ---- */
            @keyframes glowPulse {
            0% { box-shadow: 0 0 10px rgba(76, 201, 240, 0.3); }
            50% { box-shadow: 0 0 25px rgba(76, 201, 240, 0.8); }
            100% { box-shadow: 0 0 10px rgba(76, 201, 240, 0.3); }
            }

            @keyframes fadeColor {
            from { filter: brightness(1.2); opacity: 0.8; }
            to { filter: brightness(1); opacity: 1; }
            }

            #sessionBanner {
            transition: background 1.2s ease, opacity 0.8s ease;
            animation: fadeColor 1.2s ease;
            }

            #sessionBanner.active {
            animation: glowPulse 2s infinite alternate;

            /* ---- Floating Mode Indicator ---- */
            #modeIndicator {
            position: fixed;
            bottom: 20px;
            right: 25px;
            background: rgba(27, 38, 59, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 10px 18px;
            color: var(--accent);
            font-size: 0.9rem;
            font-weight: 600;
            backdrop-filter: blur(8px);
            box-shadow: 0 0 10px rgba(76, 201, 240, 0.2);
            transition: all 0.5s ease;
            z-index: 99;
            }

            #modeIndicator.active-qkd {
            background: linear-gradient(90deg, #1b263b, #4361ee);
            color: #a5f3fc;
            box-shadow: 0 0 20px rgba(76, 201, 240, 0.5);
            }

            #modeIndicator.active-hybrid {
            background: linear-gradient(90deg, #2b0b3a, #9d4edd);
            color: #fbcaff;
            box-shadow: 0 0 20px rgba(157, 78, 221, 0.5);
            }

            #modeIndicator:hover {
            transform: scale(1.05);
            }


            #sessionBanner.active {
            animation: glowPulse 2s infinite alternate;
            transition: all 0.8s ease;
            }

            @keyframes glowPulse {
            0% { box-shadow: 0 0 8px rgba(76, 201, 240, 0.2); }
            50% { box-shadow: 0 0 25px rgba(76, 201, 240, 0.7); }
            100% { box-shadow: 0 0 8px rgba(76, 201, 240, 0.2); }
            }

            #modeIndicator {
            position: fixed;
            bottom: 20px;
            right: 25px;
            background: rgba(27, 38, 59, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 10px 18px;
            color: var(--accent);
            font-size: 0.9rem;
            font-weight: 600;
            backdrop-filter: blur(8px);
            box-shadow: 0 0 10px rgba(76, 201, 240, 0.2);
            transition: all 0.5s ease;
            z-index: 99;
            }

            #modeIndicator.active-qkd {
            background: linear-gradient(90deg, #1b263b, #4361ee);
            color: #a5f3fc;
            box-shadow: 0 0 20px rgba(76, 201, 240, 0.5);
            }

            #modeIndicator.active-hybrid {
            background: linear-gradient(90deg, #2b0b3a, #9d4edd);
            color: #fbcaff;
            box-shadow: 0 0 20px rgba(157, 78, 221, 0.5);
            }

}

    </style>
</head>
<body>
    <!-- Secure Session Banner -->
    <div id="sessionBanner" style="background: linear-gradient(90deg, #e63946, #ff6b6b); color: white; text-align: center; padding: 6px; font-weight: 600; font-size: 0.9rem;">
        üîí Secure Session Not Active
    </div>

    <header class="navbar">
        <a href="{{ url_for('index_page') }}" class="logo"><i class="fas fa-lock"></i> <span>CryptexQ</span></a>
        <nav class="menu">
            <a href="{{ url_for('home_page')}}">üè† Home</a>
            <div class="dropdown">
                <a href="#">üí¨ Chat <i class="fas fa-caret-down"></i></a>
                <div class="dropdown-content">
                    <a href="{{ url_for('talkroom_page') }}">Talkroom</a>
                    <a href="{{ url_for('demo_page') }}"><i class="fas fa-shield-alt"></i> Demo</a>
                    
                </div>
            </div>
            <a href="{{ url_for('team_page') }}">üë• Team</a>
            <a href="{{ url_for('faq_page') }}">‚ùì FAQ</a>
            <div class="dropdown">
                <a href="#">üìÑ Legal <i class="fas fa-caret-down"></i></a>
                <div class="dropdown-content">
                    <a href="{{ url_for('terms_page') }}">Terms</a>
                    <a href="{{ url_for('about_page') }}">About</a>
                </div>
            </div>
            <a href="{{ url_for('contact_page') }}">‚úâ Contact</a>
        </nav>
        <div class="actions">
            <a href="{{ url_for('login_route') }}" class="btn btn-login">üîë Login</a>
            <a href="{{ url_for('signup_route') }}" class="btn btn-signup">üë§ Sign Up</a>
        </div>
    </header>

    <div class="container">
        <div style="text-align:center; margin: 2rem 0 1rem;">
            <h1>CryptexQ Secure Chat Room</h1>
            <p style="color: var(--light);">End-to-end encrypted messaging with quantum-inspired security</p>
        </div>
        
        <div class="tab-container">
            <div class="tab active" onclick="switchTab('chat')">Secure Chat</div>
            <div class="tab" onclick="switchTab('explanation')">How It Works</div>
            <div class="tab" onclick="switchTab('settings')">Settings</div>
        </div>
        
        <div class="tab-content active" id="chat-tab">
            <div class="chat-container">
                <div class="status-bar">
                    <div class="status-indicator">
                        <div class="status-dot disconnected" id="connection-dot"></div>
                        <span id="connection-status">Connection: Not Established</span>
                    </div>
                    <div>
                        <span id="session-status">Encryption: Not Established</span>
                    </div>
                </div>
                
                <div class="key-exchange">
                    <div class="key-box">
                        <h3>Your Public Key</h3>
                        <div class="key-value" id="public-key">
                            Not generated yet
                            <button class="copy-btn" onclick="copyToClipboard('public-key')" style="display: none;">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                        <button id="generate-btn"><i class="fas fa-key"></i> Generate Keys & Register</button>
                    </div>
                    
                    <div class="key-box">
                        <h3>Friend's Public Key</h3>
                        <div class="key-value" id="friend-key">
                            Waiting for friend to connect...
                            <button class="copy-btn" onclick="copyToClipboard('friend-key')" style="display: none;">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                        <button id="friend-btn" disabled><i class="fas fa-user-friends"></i> Enter Friend's Key (optional)</button>
                    </div>
                    
                    <div class="key-box">
                        <h3>Session Key</h3>
                        <div class="key-value" id="session-key">
                            Not established yet
                            <button class="copy-btn" onclick="copyToClipboard('session-key')" style="display: none;">
                                <i class="fas fa-copy"></i> Copy</button>
                        </div>
                        <button id="session-btn" disabled><i class="fas fa-handshake"></i> Establish Session</button>
                    </div>
                </div>
                
                <div class="mode-settings">
                    <div id="security-mode-box">
                        <label for="securityMode" style="font-weight: bold;">
                            <i class="fas fa-shield-alt"></i> Encryption Mode:
                        </label>
                        <select id="securityMode"
                                style="padding: 6px; margin-left: 10px; background: var(--primary-dark); color: var(--accent); border: 1px solid var(--medium); border-radius: 4px;">
                            <option value="qkd">QKD + AES (Default)</option>
                            <option value="hybrid">Hybrid (Kyber PQC + AES-256)</option>
                        </select>
                    
                        <button id="applyModeBtn" style="padding: 6px 12px; margin-top: 15px; width: auto;">
                            <i class="fas fa-check"></i> Apply Mode</button>
                    
                        <div id="modeStatus"
                             style="margin-top: 10px; font-weight: 500; font-size: 0.85rem; color: var(--highlight);">
                            Default QKD mode active.
                        </div>
                    </div>
                </div>
                    
                <div style="margin:10px;">
                    <label>Mode (for demo):</label>
                    <select id="modeSelect">
                        <option value="qkd">QKD + AES</option>
                        <option value="hybrid">Hybrid PQC-Kyber + AES</option>
                    </select>
                    <button id="start-btn">Start Session</button>
                </div>

                <div class="chat-area">
                    <div class="chat-messages" id="chat-messages">
                        <div class="message received">
                            <div>Welcome to CryptexQ Secure Chat! Generate your keys to begin encrypted messaging.</div>
                            <div class="message-info">System ‚Ä¢ Just now</div>
                        </div>
                    </div>
                    
                    <div class="input-area">
                        <input type="text" id="message-input" placeholder="Type your message here..." disabled>
                        <button id="send-btn" disabled><i class="fas fa-paper-plane"></i> Send</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="explanation-tab">
            <div class="explanation">
                <h3><i class="fas fa-info-circle"></i> How CryptexQ Secure Chat Works</h3>
                <p>This implementation demonstrates a production-ready secure messaging system with quantum-inspired encryption:</p>
                <ol>
                    <li><strong>Key Generation</strong> ‚Äì Each user generates a public/private key pair in the browser. The public key is sent to the server and <b>shown in full</b> in ‚ÄúYour Public Key‚Äù.</li>
                    <li><strong>Key Exchange</strong> ‚Äì The server uses those public keys to perform either simulated QKD or post-quantum Kyber KEM, depending on the selected mode.</li>
                    <li><strong>Session Establishment</strong> ‚Äì A shared secret is derived and turned into an AES-256 key using WebCrypto.</li>
                    <li><strong>Message Encryption</strong> ‚Äì All chat messages are encrypted with AES-GCM in the browser before being sent.</li>
                    <li><strong>Message Decryption</strong> ‚Äì The receiving browser decrypts using the same session key. The server never sees plaintext.</li>
                </ol>
            </div>
        </div>
        
        <div class="tab-content" id="settings-tab">
            <div class="explanation">
                <h3><i class="fas fa-cog"></i> Application Settings</h3>
                <div style="margin-top: 20px;">
                    <label>
                        <input type="checkbox" id="auto-copy-key" checked>
                        Auto-copy generated keys to clipboard
                    </label>
                </div>
                <div style="margin-top: 15px;">
                    <label>
                        <input type="checkbox" id="show-encrypted" checked>
                        Show encrypted message content (in console)
                    </label>
                </div>
                <div style="margin-top: 15px;">
                    <label>
                        <input type="checkbox" id="auto-establish" checked>
                        Automatically establish session when both users are ready
                    </label>
                </div>
                <div style="margin-top: 30px;">
                    <button id="reset-btn"><i class="fas fa-undo"></i> Reset Application</button>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>CryptexQ Secure Chat ‚Ä¢ Quantum-Inspired Encryption Technology</p>
        </div>
    </div>
    
    <!-- Friend Key Modal (still available for manual demo if needed) -->
    <div class="modal" id="friend-key-modal">
        <div class="modal-content">
            <h2>Enter Friend's Public Key</h2>
            <input type="text" id="friend-key-input" placeholder="Paste friend's public key here">
            <div class="modal-buttons">
                <button class="secondary" onclick="hideFriendKeyModal()">Cancel</button>
                <button onclick="saveFriendKey()">Save Key</button>
            </div>
        </div>
    </div>

    <!-- Socket.IO client from CDN (no integrity hash) -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js" crossorigin="anonymous"></script>

    <script>
    // -------- Tabs --------
    function switchTab(tabId) {
        document.querySelectorAll(".tab-content").forEach(div => div.classList.remove("active"));
        document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
        document.getElementById(tabId + "-tab").classList.add("active");
        document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add("active");
    }

    // -------- Socket & state --------
    const socket = io();
    let username = null;
    let peer = null;
    let aesKey = null;
    let mode = "qkd"; // default
    let myPubB64 = null;

    // DOM refs
    const connectionDot = document.getElementById("connection-dot");
    const connectionStatus = document.getElementById("connection-status");
    const sessionStatus = document.getElementById("session-status");
    const sessionBanner = document.getElementById("sessionBanner");

    const publicKeyBox = document.getElementById("public-key");
    const friendKeyBox = document.getElementById("friend-key");
    const sessionKeyBox = document.getElementById("session-key");

    const generateBtn = document.getElementById("generate-btn");
    const friendBtn = document.getElementById("friend-btn");
    const sessionBtn = document.getElementById("session-btn");
    const sendBtn = document.getElementById("send-btn");
    const messageInput = document.getElementById("message-input");
    const chatBox = document.getElementById("chat-messages");
    const securityModeSelect = document.getElementById("securityMode");
    const modeSelect = document.getElementById("modeSelect");

    // -------- Utils --------
    function updateStatus(text, colorClass = "connected") {
        connectionDot.className = "status-dot " + colorClass;
        connectionStatus.textContent = "Connection: " + text;
    }

        function updateBanner(active, text) {
        if (active) {
            sessionBanner.style.background =
            mode === "qkd"
                ? "linear-gradient(90deg, #00b4d8, #4361ee)"
                : "linear-gradient(90deg, #b5179e, #7209b7)";
            sessionBanner.textContent = "üîê " + text;
            sessionBanner.classList.add("active");

            // üîä Sound + flash effect
            playSound("connect");
            sessionBanner.animate(
            [
                { opacity: 0.5, transform: "scale(0.95)" },
                { opacity: 1, transform: "scale(1.05)" },
                { opacity: 1, transform: "scale(1)" },
            ],
            { duration: 1200, easing: "ease-out" }
            );
        } else {
            sessionBanner.style.background =
            "linear-gradient(90deg, #e63946, #ff6b6b)";
            sessionBanner.textContent = text || "üîí Secure Session Not Active";
            sessionBanner.classList.remove("active");
            playSound("disconnect");
        }
}


        // ---- Floating Mode Indicator Logic ----
       function updateModeIndicator() {
        const el = document.getElementById("modeIndicator");
        if (!el) return;

        if (mode === "qkd") {
            el.classList.remove("active-hybrid");
            el.classList.add("active-qkd");
            el.innerHTML = `Mode: <span id="modeIndicatorText">QKD + AES</span> üîµ`;
        } else {
            el.classList.remove("active-qkd");
            el.classList.add("active-hybrid");
            el.innerHTML = `Mode: <span id="modeIndicatorText">Hybrid PQC-Kyber + AES</span> üü£`;
        }

        el.animate(
            [
            { transform: "scale(1)", opacity: 1 },
            { transform: "scale(1.1)", opacity: 0.8 },
            { transform: "scale(1)", opacity: 1 },
            ],
            { duration: 600, easing: "ease-out" }
        );
}



    function copyToClipboard(elementId) {
        const el = document.getElementById(elementId);
        const text = el.textContent.trim();
        if (!text) return;
        navigator.clipboard.writeText(text);
    }

    function handleKeyPress(e) {
        if (e.key === "Enter") {
            e.preventDefault();
            sendMessage();
        }
    }

    function resetApplication() {
        window.location.reload();
    }

    // -------- Socket events --------
    socket.on("connect", () => updateStatus("Connected", "connected"));
    socket.on("disconnect", () => updateStatus("Disconnected", "disconnected"));

   async function ensureRegistered() {
    if (username && myPubB64) return;

    // ‚úÖ Try reading from localStorage
    username = localStorage.getItem("cryptexq_username");

    if (!username) {
        // fallback for direct link access
        username = prompt("Enter your username to continue:");
        if (!username) return;
        localStorage.setItem("cryptexq_username", username);
    }

  // proceed with ECDH keygen


  await new Promise(r => requestAnimationFrame(r)); // ensures gesture unlock

  const kp = await crypto.subtle.generateKey(
      { name: "ECDH", namedCurve: "P-256" },
      true,
      ["deriveKey", "deriveBits"]
  );
  window.ecdhKeyPair = kp;

  const pubRaw = await crypto.subtle.exportKey("raw", kp.publicKey);
  myPubB64 = btoa(String.fromCharCode(...new Uint8Array(pubRaw)));
  publicKeyBox.textContent = myPubB64;

  const copyBtn = document.querySelector("#public-key .copy-btn");
  if (copyBtn) copyBtn.style.display = "inline-block";

  socket.emit("register", { username, x25519_pub_b64: myPubB64 });
}



    socket.on("registered", data => {
        sessionStatus.textContent = `‚úÖ Registered as ${data.username}`;
        updateStatus("Online", "connected");
    });
    // ------------------- ONLINE USERS HANDLING -------------------
// ------------------- ONLINE USERS HANDLING (AUTO SESSION) -------------------
socket.on("online_users", data => {
  console.log("[online_users]", data);
  const list = data.users.filter(u => u !== username);

  if (list.length > 0) {
    peer = list[0];
    friendKeyBox.textContent = "Connected to: " + peer;
    friendBtn.disabled = false;
    sessionBtn.disabled = false;

    // Automatically start session if user chose auto-establish
    const auto = document.getElementById("auto-establish");
    if (auto && auto.checked && !aesKey) {
      console.log("[auto] establishing session with", peer, "in mode", mode);
      sessionKeyBox.textContent = "Negotiating secure session via " +
        (mode === "qkd" ? "QKD" : "Hybrid Kyber") + "...";
      if (mode === "qkd") {
        socket.emit("start_qkd_session", { from: username, to: peer });
      } else {
        socket.emit("request_start_session", { from: username, to: peer });
      }
    }

  } else {
    friendKeyBox.textContent = "Waiting for friend to connect...";
    friendBtn.disabled = true;
    sessionBtn.disabled = true;
    peer = null;
  }
});


    // -------- Mode handling --------
        function syncModeUI() {
        securityModeSelect.value = mode;
        modeSelect.value = mode;

        const modeText =
            mode === "qkd"
            ? "QKD + AES mode active."
            : "Hybrid PQC-Kyber + AES mode active.";

        document.getElementById("modeStatus").textContent = modeText;

        updateBanner(false, `Switched to ${modeText} (re-establish to apply)`);
        updateModeIndicator(); // <-- üü¢ Add this line
        }


    function applyMode() {
  mode = securityModeSelect.value;
  syncModeUI();
  updateModeIndicator(); // üü¢ live update
  if (peer) startSession();
}


    securityModeSelect.addEventListener("change", () => {
        mode = securityModeSelect.value;
        syncModeUI();
    });

    modeSelect.addEventListener("change", () => {
        mode = modeSelect.value;
        syncModeUI();
    });

    // -------- Friend key modal (optional manual demo) --------
    function showFriendKeyModal() {
        document.getElementById("friend-key-modal").style.display = "flex";
    }
    function hideFriendKeyModal() {
        document.getElementById("friend-key-modal").style.display = "none";
    }
    function saveFriendKey() {
        const val = document.getElementById("friend-key-input").value.trim();
        if (val) {
            friendKeyBox.textContent = val;
            sessionBtn.disabled = false;
            hideFriendKeyModal();
        }
    }

    // Make these functions available to inline HTML
    window.showFriendKeyModal = showFriendKeyModal;
    window.hideFriendKeyModal = hideFriendKeyModal;
    window.saveFriendKey = saveFriendKey;
    window.copyToClipboard = copyToClipboard;
    window.switchTab = switchTab;
    window.handleKeyPress = handleKeyPress;

    // -------- Key generation & session --------
    async function generateKeys() {
        await ensureRegistered();
        friendBtn.disabled = false;
    }

    function startSession() {
        if (!peer) {
            alert("No peer available yet. Open talkroom on another device/tab and register there.");
            return;
        }
        sessionKeyBox.textContent = "Negotiating secure session via " + (mode === "qkd" ? "QKD" : "Hybrid Kyber") + "...";
        if (mode === "qkd") {
            socket.emit("start_qkd_session", { from: username, to: peer });
        } else {
            socket.emit("request_start_session", { from: username, to: peer });
        }
    }

    socket.on("qkd_shared_key", async data => {
        const raw = Uint8Array.from(atob(data.shared_b64), c => c.charCodeAt(0));
        aesKey = await crypto.subtle.importKey("raw", raw, { name:"AES-GCM" }, false, ["encrypt","decrypt"]);
        sessionKeyBox.textContent = "üîê AES-256 Session Key (from QKD) ‚Äì value hidden";
        const copyBtn = document.querySelector("#session-key .copy-btn");
        if (copyBtn) copyBtn.style.display = "none";

        sendBtn.disabled = false;
        messageInput.disabled = false;
        updateBanner(true, "QKD-AES session active");
        sessionStatus.textContent = "üîê Session Active";
    });

    socket.on("kyber_shared_for_initiator", async data => {
        const raw = Uint8Array.from(atob(data.kyber_ss_b64), c => c.charCodeAt(0));
        aesKey = await crypto.subtle.importKey("raw", raw, { name:"AES-GCM" }, false, ["encrypt","decrypt"]);
        sessionKeyBox.textContent = "üîê AES-256 Session Key (from Kyber PQC) ‚Äì value hidden";
        const copyBtn = document.querySelector("#session-key .copy-btn");
        if (copyBtn) copyBtn.style.display = "none";

        sendBtn.disabled = false;
        messageInput.disabled = false;
        updateBanner(true, "Hybrid PQC-Kyber session active");
        sessionStatus.textContent = "üîê Hybrid PQC-Kyber session active";
    });

    socket.on("kyber_ready_peer", async data => {
        const raw = Uint8Array.from(atob(data.kyber_ss_b64), c => c.charCodeAt(0));
        aesKey = await crypto.subtle.importKey("raw", raw, { name:"AES-GCM" }, false, ["encrypt","decrypt"]);
        sessionKeyBox.textContent = "üîê AES-256 Session Key (from Kyber PQC) ‚Äì value hidden";
        const copyBtn = document.querySelector("#session-key .copy-btn");
        if (copyBtn) copyBtn.style.display = "none";

        sendBtn.disabled = false;
        messageInput.disabled = false;
        updateBanner(true, "Hybrid PQC-Kyber session active");
        sessionStatus.textContent = "üîê Hybrid PQC-Kyber session active";
    });

    // -------- Chat --------
    async function sendMessage() {
        if (!aesKey) return alert("No active session key!");
        const msg = messageInput.value.trim();
        if (!msg) return;

          // üü¢  for demo clarity
        console.log(`[mode] Encrypting using mode: ${mode}`);
        console.log(`[key source] Using ${mode === 'qkd' ? 'Quantum-derived key' : mode === 'pqc' ? 'Kyber512 public key exchange' : 'Hybrid key mix'}`);

        const iv = crypto.getRandomValues(new Uint8Array(12));
        const ctBuf = await crypto.subtle.encrypt(
            { name:"AES-GCM", iv },
            aesKey,
            new TextEncoder().encode(msg)
        );
        const ctUint8 = new Uint8Array(ctBuf);
        const ctB64 = btoa(String.fromCharCode(...ctUint8));
        const ivB64 = btoa(String.fromCharCode(...iv));

        if (document.getElementById("show-encrypted").checked) {
            console.log("Ciphertext (b64):", ctB64);
            console.log("IV (b64):", ivB64);
        }

        socket.emit("send_encrypted_message", {
            from: username,
            to: peer,
            ciphertext_b64: ctB64,
            iv_b64: ivB64
        });
        addMessage("You", msg);
        messageInput.value = "";
    }

    socket.on("new_encrypted_message", async data => {
        if (!aesKey) {
            console.warn("Received encrypted message but no AES key yet");
            return;
        }
        const ct = Uint8Array.from(atob(data.ciphertext_b64), c => c.charCodeAt(0));
        const iv = Uint8Array.from(atob(data.iv_b64), c => c.charCodeAt(0));
        const ptBuf = await crypto.subtle.decrypt(
            { name:"AES-GCM", iv },
            aesKey,
            ct
        );
        const msg = new TextDecoder().decode(ptBuf);
        addMessage(data.from, msg);
    });

    function addMessage(sender, text) {
        const div = document.createElement("div");
        div.className = "message " + (sender === "You" ? "sent" : "received");
        div.innerHTML = `<strong>${sender}:</strong> ${text}`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // -------- Init --------
    window.addEventListener("DOMContentLoaded", () => {
        syncModeUI();
        generateBtn.onclick = generateKeys;
        friendBtn.onclick = showFriendKeyModal;
        sessionBtn.onclick = startSession;
        document.getElementById("start-btn").onclick = startSession;
        sendBtn.onclick = sendMessage;
        messageInput.addEventListener("keypress", handleKeyPress);
        document.getElementById("applyModeBtn").onclick = applyMode;
        document.getElementById("reset-btn").onclick = resetApplication;
    });
    // Optional: subtle sound cues for connection/mode change
        function playSound(type) {
        const soundUrl =
            type === "connect"
            ? "https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3"
            : "https://assets.mixkit.co/sfx/preview/mixkit-system-beep-buzzer-fail-2964.mp3";
        new Audio(soundUrl).play();
        }
    </script>
    <!-- Floating Mode Label -->
<div id="modeIndicator">
  Mode: <span id="modeIndicatorText">QKD + AES</span> üîµ
</div>

</body>
</html>
